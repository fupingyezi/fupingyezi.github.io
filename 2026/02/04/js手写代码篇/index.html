
  <!DOCTYPE html>
  <html lang="en"  >
  <head>
  <meta charset="utf-8">
  

  

  

  
  <script>window.icon_font = '4552607_tq6stt6tcg';window.clipboard_tips = {"success":"复制成功(*^▽^*)","fail":"复制失败 (ﾟ⊿ﾟ)ﾂ","copyright":{"enable":false,"count":50,"content":"本文版权：本博客所有文章除特别声明外，均采用 BY-NC-SA 许可协议。转载请注明出处！"}};</script>
  
  
  <title>
    前端面试篇——js手写 |
    
    Tu Yuheng&#39;s Blog
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link rel="preload" as="style" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Mulish:400,400italic,700,700italic%7CNoto%20Serif%20SC:400,400italic,700,700italic&display=swap" media="print" onload="this.media&#x3D;&#39;all&#39;">
  
    <link rel="preload" href="//at.alicdn.com/t/c/font_4552607_tq6stt6tcg.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  
    
<link rel="stylesheet" href="/css/loader.css">

  
  
    <meta name="description" content="本篇内容会持续更新，上次更新为2025-02-03  一、手写深拷贝 从浅拷贝一步一步进步。  我们知道浅拷贝是对引用数据的第一层拷贝，而深拷贝是一直拷贝到最后一层。 浅拷贝所以我们很容易做到手写浅拷贝： 123456789function shallowCopy(obj) {  if (typeof obj !&#x3D;&#x3D; &quot;object&quot; || obj &#x3D;&#x3D; null) return obj;  c">
<meta property="og:type" content="article">
<meta property="og:title" content="前端面试篇——js手写">
<meta property="og:url" content="http://fupingyezi.github.io/2026/02/04/js%E6%89%8B%E5%86%99%E4%BB%A3%E7%A0%81%E7%AF%87/index.html">
<meta property="og:site_name" content="Tu Yuheng&#39;s Blog">
<meta property="og:description" content="本篇内容会持续更新，上次更新为2025-02-03  一、手写深拷贝 从浅拷贝一步一步进步。  我们知道浅拷贝是对引用数据的第一层拷贝，而深拷贝是一直拷贝到最后一层。 浅拷贝所以我们很容易做到手写浅拷贝： 123456789function shallowCopy(obj) {  if (typeof obj !&#x3D;&#x3D; &quot;object&quot; || obj &#x3D;&#x3D; null) return obj;  c">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://fupingyezi.github.io/images/8.31edit/Pasted-image-20250809211828.png">
<meta property="og:image" content="http://fupingyezi.github.io/images/8.31edit/Pasted-image-20250810010740.png">
<meta property="article:published_time" content="2026-02-03T16:00:00.000Z">
<meta property="article:modified_time" content="2026-02-04T09:52:36.767Z">
<meta property="article:author" content="Tu Yuheng">
<meta property="article:tag" content="组会分享">
<meta property="article:tag" content="前端面试">
<meta property="article:tag" content="JavaScript">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://fupingyezi.github.io/images/8.31edit/Pasted-image-20250809211828.png">
  
  
    <link rel="alternate" href="/atom.xml" title="Tu Yuheng's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

  <link rel="preload" href="https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
    
      
<link rel="stylesheet" href="https://npm.webcache.cn/katex@0.16.9/dist/katex.min.css">

    
  
  
  
  
    
<script src="https://npm.webcache.cn/pace-js@1.2.4/pace.min.js" integrity="sha384-k6YtvFUEIuEFBdrLKJ3YAUbBki333tj1CSUisai5Cswsg9wcLNaPzsTHDswp4Az8" crossorigin="anonymous"></script>

  
  
    
<link rel="stylesheet" href="https://npm.webcache.cn/@reimujs/aos@0.1.0/dist/aos.css">

  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

  <body>
    
  <div id='loader'>
    <div class="loading-left-bg loading-bg"></div>
    <div class="loading-right-bg loading-bg"></div>
    <div class="spinner-box">
      <div class="loading-taichi">
        <svg width="150" height="150" viewBox="0 0 1024 1024" class="icon" version="1.1" xmlns="https://www.w3.org/2000/svg" shape-rendering="geometricPrecision">
          <path d="M303.5 432A80 80 0 0 1 291.5 592A80 80 0 0 1 303.5 432z" fill="#ff5252" />
          <path d="M512 65A447 447 0 0 1 512 959L512 929A417 417 0 0 0 512 95A417 417 0 0 0 512 929L512 959A447 447 0 0 1 512 65z 
         M512 95A417 417 0 0 1 929 512A208.5 208.5 0 0 1 720.5 720.5L720.5 592A80 80 0 0 0 720.5 432A80 80 0 0 0 720.5 592L720.5 720.5A208.5 208.5 0 0 1 512 512A208.5 208.5 0 0 0 303.5 303.5A208.5 208.5 0 0 0 95 512A417 417 0 0 1 512 95z" fill="#ff5252" />
        </svg>
      </div>
      <div class="loading-word">少女祈祷中...</div>
    </div>
  </div>
  </div>
  <script>
    var time = null;
    var startLoading = () => {
      time = Date.now();
      document.getElementById('loader').classList.remove("loading");
    }
    var endLoading = () => {
      if (!time) {
        document.body.style.overflow = 'auto';
        document.getElementById('loader').classList.add("loading");
      } else {
        if (Date.now() - time > 500) {
          time = null;
          document.body.style.overflow = 'auto';
          document.getElementById('loader').classList.add("loading");
        } else {
          setTimeout(endLoading, 500 - (Date.now() - time));
          time = null;
        }
      }
    }
    window.addEventListener('DOMContentLoaded', endLoading);
    document.getElementById('loader').addEventListener('click', endLoading);
  </script>

<div id="copy-tooltip" style="pointer-events: none; opacity: 0; transition: all 0.2s ease; position: fixed;top: 50%;left: 50%;z-index: 999;transform: translate(-50%, -50%);color: white;background: rgba(0, 0, 0, 0.5);padding: 10px 15px;border-radius: 10px;">
</div>


    <div id="container">
      <div id="wrap">
        <div id="header-nav">
  <nav id="main-nav">
    
      <span class="main-nav-link-wrap">
        <div class="main-nav-icon icon-taichi"></div>
        <a class="main-nav-link" href="/">Home</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class="main-nav-icon icon-taichi"></div>
        <a class="main-nav-link" href="/archives">Archives</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class="main-nav-icon icon-taichi"></div>
        <a class="main-nav-link" href="/about">About</a>
      </span>
    
      <span class="main-nav-link-wrap">
        <div class="main-nav-icon icon-taichi"></div>
        <a class="main-nav-link" href="/friend">Friend</a>
      </span>
    
    <a id="main-nav-toggle" class="nav-icon"></a>
  </nav>
  <nav id="sub-nav">
    
      <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed" target="_blank"></a>
    
    
    
  </nav>
</div>
<header id="header">
  
    
      <img fetchpriority="high" src="/images/banner.webp" alt="前端面试篇——js手写">
    
  
  <div id="header-outer">
    <div id="header-title">
      
        
        
          <a href="/" id="logo">
            <h1 data-aos="slide-up">前端面试篇——js手写</h1>
          </a>
        
      
      
        
        <h2 id="subtitle-wrap" data-aos="slide-down">
          
        </h2>
      
    </div>
  </div>
</header>

        <div id="content">
          
          <section id="main"><article id="post-js手写代码篇" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-inner" data-aos="fade-up">
    <div class="article-meta">
      <div class="article-date">
  <a href="/2026/02/04/js%E6%89%8B%E5%86%99%E4%BB%A3%E7%A0%81%E7%AF%87/" class="article-date-link" data-aos="zoom-in">
    <time datetime="2026-02-03T16:00:00.000Z" itemprop="datePublished">2026-02-04</time>
    <time style="display: none;" id="post-update-time">2026-02-04</time>
  </a>
</div>

      

    </div>
    <div class="hr-line"></div>
    

    <div class="e-content article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>本篇内容会持续更新，上次更新为2025-02-03</p>
</blockquote>
<h1 id="一、手写深拷贝"><a href="#一、手写深拷贝" class="headerlink" title="一、手写深拷贝"></a>一、手写深拷贝</h1><blockquote>
<p>从浅拷贝一步一步进步。</p>
</blockquote>
<p>我们知道浅拷贝是对引用数据的第一层拷贝，而深拷贝是一直拷贝到最后一层。</p>
<h3 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h3><p>所以我们很容易做到手写浅拷贝：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">shallowCopy</span>(<span class="params">obj</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newObj = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj) ? [] : {};</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) {</span><br><span class="line">    <span class="keyword">if</span> (obj.<span class="title function_">hasOwnProperty</span>(key)) newObj[key] = obj[key];</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> newObj;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>注意使用<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="17.219ex" height="2.057ex" role="img" focusable="false" viewBox="0 -704 7611 909"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(576,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(1105,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(1574,0)"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path></g><g data-mml-node="mi" transform="translate(2337,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mi" transform="translate(3053,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3653,0)"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path></g><g data-mml-node="mi" transform="translate(4404,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(4855,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(5340,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mi" transform="translate(5843,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(6309,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(6760,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(7121,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g></g></g></svg></mjx-container>防止错误添加对象原型链上的属性。</p>
<h3 id="深拷贝-v1"><a href="#深拷贝-v1" class="headerlink" title="深拷贝 v1"></a>深拷贝 v1</h3><p>浅拷贝是一层拷贝，深拷贝是每一层都拷贝，所以我们也能很容易想到用递归在每层都实现浅拷贝：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deepClone</span>(<span class="params">obj</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> obj !== <span class="string">"object"</span> || obj == <span class="literal">null</span>) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newObj = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj) ? [] : {};</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> obj) {</span><br><span class="line">    <span class="keyword">if</span> (obj.<span class="title function_">hasOwnProperty</span>(key)) {</span><br><span class="line">      newObj[key] = <span class="title function_">deepClone</span>(obj[key]);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newObj;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="深拷贝-v2"><a href="#深拷贝-v2" class="headerlink" title="深拷贝 v2"></a>深拷贝 v2</h3><p>上面实现的深拷贝为最基础深拷贝，还有很多问题，比如：</p>
<ul>
<li>循环引用导致爆栈</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = {};</span><br><span class="line">a.<span class="property">self</span> = a;</span><br><span class="line"><span class="title function_">deepClone</span>(a);</span><br></pre></td></tr></table></figure>
<ul>
<li>特殊对象全部变成了普通对象或者数组</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Date</span> → {}</span><br><span class="line"><span class="title class_">RegExp</span> → {}</span><br><span class="line"><span class="title class_">Map</span> / <span class="title class_">Set</span> → {}</span><br><span class="line"><span class="title class_">ArrayBuffer</span> / <span class="title class_">TypedArray</span> →只拷贝了可枚举字段，数据丢失</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Object.create(null)</code>创造的对象没有<code>hasOwnProperty</code>方法<br><img src="/images/8.31edit/Pasted-image-20250809211828.png" alt=""><br>所以我们对着三个点进行优化；</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deepClone</span>(<span class="params">obj, map = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span>) {</span><br><span class="line">  <span class="keyword">if</span> (obj === <span class="literal">null</span> || <span class="keyword">typeof</span> obj !== <span class="string">"object"</span>) <span class="keyword">return</span> obj;</span><br><span class="line">  <span class="keyword">if</span> (map.<span class="title function_">has</span>(obj)) <span class="keyword">return</span> map.<span class="title function_">get</span>(obj);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">Date</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(obj);</span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">RegExp</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RegExp</span>(obj);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(obj)) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> obj.<span class="title function_">constructor</span>(<span class="params">obj.buffer.slice(<span class="number">0</span>)</span>);</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">ArrayBuffer</span>) {</span><br><span class="line">    <span class="keyword">return</span> obj.<span class="title function_">slice</span>(<span class="number">0</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj) ? [] : {};</span><br><span class="line">  map.<span class="title function_">set</span>(obj, res);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> obj) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(obj, key)) {</span><br><span class="line">      res[key] = <span class="title function_">deepClone</span>(obj[key], map);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>不过中间那四个点（即特殊对象判断）也不是必须的，一般来说掌握：</p>
<ul>
<li><code>for...in</code>会遍历原型链，需要<code>hasOwnProperty</code>过滤。</li>
<li>裸对象没有<code>hasOwnProperty</code>，需要使用<code>Object.prototype.hasOwnProperty.call</code>。</li>
<li><code>map</code>存储防止循环引用。<br>这三点就够了。<br>即</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deepClone</span>(<span class="params">obj, map = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span>) {</span><br><span class="line">  <span class="keyword">if</span> (obj === <span class="literal">null</span> || <span class="keyword">typeof</span> obj !== <span class="string">"object"</span>) <span class="keyword">return</span> obj;</span><br><span class="line">  <span class="keyword">if</span> (map.<span class="title function_">has</span>(obj)) <span class="keyword">return</span> map.<span class="title function_">get</span>(obj);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj) ? [] : {};</span><br><span class="line">  map.<span class="title function_">set</span>(obj, res);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> obj) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(obj, key)) {</span><br><span class="line">      res[key] = <span class="title function_">deepClone</span>(obj[key], map);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>如果还问递归层特别深怎么办，就改成栈来模拟递归。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">cloneDeep</span>(<span class="params">obj</span>) {</span><br><span class="line">  <span class="keyword">if</span> (obj === <span class="literal">null</span> || <span class="keyword">typeof</span> obj !== <span class="string">"object"</span>) <span class="keyword">return</span> obj;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> root = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj) ? [] : {};</span><br><span class="line">  <span class="keyword">const</span> stack = [{ <span class="attr">parent</span>: root, <span class="attr">key</span>: <span class="literal">undefined</span>, <span class="attr">data</span>: obj }];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (stack.<span class="property">length</span>) {</span><br><span class="line">    <span class="keyword">const</span> { parent, key, data } = stack.<span class="title function_">pop</span>();</span><br><span class="line">    <span class="keyword">const</span> current =</span><br><span class="line">      key === <span class="literal">undefined</span></span><br><span class="line">        ? parent</span><br><span class="line">        : (parent[key] = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(data) ? [] : {});</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> k <span class="keyword">in</span> data) {</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(data, k)) {</span><br><span class="line">        <span class="keyword">const</span> val = data[k];</span><br><span class="line">        <span class="keyword">if</span> (val === <span class="literal">null</span> || <span class="keyword">typeof</span> val !== <span class="string">"object"</span>) {</span><br><span class="line">          current[k] = val;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">          stack.<span class="title function_">push</span>({ <span class="attr">parent</span>: current, <span class="attr">key</span>: k, <span class="attr">data</span>: val });</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="深拷贝-v3"><a href="#深拷贝-v3" class="headerlink" title="深拷贝 v3"></a>深拷贝 v3</h3><p>但其实，工程化的深拷贝还需要考虑 symbol 和不可访问属性，以及保持原型链</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">deepClone</span>(<span class="params">obj, map = <span class="keyword">new</span> <span class="built_in">WeakMap</span>()</span>) {</span><br><span class="line">  <span class="keyword">if</span> (obj === <span class="literal">null</span> || <span class="keyword">typeof</span> obj !== <span class="string">"object"</span>) <span class="keyword">return</span> obj;</span><br><span class="line">  <span class="keyword">if</span> (map.<span class="title function_">has</span>(obj)) <span class="keyword">return</span> map.<span class="title function_">get</span>(obj);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">Date</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(obj);</span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">RegExp</span>) <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RegExp</span>(obj);</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">ArrayBuffer</span>.<span class="title function_">isView</span>(obj)) <span class="keyword">return</span> <span class="keyword">new</span> obj.<span class="title function_">constructor</span>(<span class="params">obj.buffer.slice(<span class="number">0</span>)</span>);</span><br><span class="line">  <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> <span class="title class_">ArrayBuffer</span>) <span class="keyword">return</span> obj.<span class="title function_">slice</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> res = <span class="title class_">Array</span>.<span class="title function_">isArray</span>(obj)</span><br><span class="line">    ? []</span><br><span class="line">    : <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Object</span>.<span class="title function_">getPrototypeOf</span>(obj)); <span class="comment">// 原型链保持</span></span><br><span class="line">  map.<span class="title function_">set</span>(obj, res);</span><br><span class="line"></span><br><span class="line">  <span class="title class_">Reflect</span>.<span class="title function_">ownKeys</span>(obj).<span class="title function_">forEach</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> {</span><br><span class="line">    res[key] = <span class="title function_">deepClone</span>(obj[key], map);</span><br><span class="line">  });</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h3 id="深拷贝-v4"><a href="#深拷贝-v4" class="headerlink" title="深拷贝 v4"></a>深拷贝 v4</h3><p>也可以善用工具偷懒</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> o = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj));</span><br><span class="line"><span class="keyword">const</span> o = _.<span class="title function_">cloneDeep</span>(obj); <span class="comment">//lodash</span></span><br></pre></td></tr></table></figure>
<h1 id="二、手写获取对象类型"><a href="#二、手写获取对象类型" class="headerlink" title="二、手写获取对象类型"></a>二、手写获取对象类型</h1><p>在 JavaScript 中，每个内置对象都有一个内部属性 <code>[[Class]]</code>，表示其原始类型。<br><code>Object.prototype.toString</code> 会返回这个类型的字符串表示，格式固定为：<br><code>"[object Type]"</code><br>其中 <code>Type</code> 是一个字符串，表示该值的原始类型，例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="literal">null</span>); <span class="comment">// "[object Null]"</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>([]); <span class="comment">// "[object Array]"</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="function">() =&gt;</span> {}); <span class="comment">// "[object Function]"</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="keyword">new</span> <span class="title class_">Date</span>()); <span class="comment">// "[object Date]"</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(<span class="regexp">/abc/</span>); <span class="comment">// "[object RegExp]"</span></span><br></pre></td></tr></table></figure>
<p>所以：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getType</span>(<span class="params">data</span>) {</span><br><span class="line">  <span class="comment">// 获取到 "[object Type]"，其中 Type 是 Null、Undefined、Array、Function、Error、Boolean、Number、String、Date、RegExp 等。</span></span><br><span class="line">  <span class="keyword">const</span> originType = <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(data);</span><br><span class="line">  <span class="comment">// 可以直接截取第8位和倒数第一位，这样就获得了 Null、Undefined、Array、Function、Error、Boolean、Number、String、Date、RegExp 等</span></span><br><span class="line">  <span class="keyword">const</span> type = originType.<span class="title function_">slice</span>(<span class="number">8</span>, -<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// 再转小写，得到 null、undefined、array、function 等</span></span><br><span class="line">  <span class="keyword">return</span> type.<span class="title function_">toLowerCase</span>();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="三、手写防抖"><a href="#三、手写防抖" class="headerlink" title="三、手写防抖"></a>三、手写防抖</h1><p>我们知道防抖就是回城，每次打断会重新计时，也就是对防抖函数定义一个计时器，如果在计时器时间内重新触发就消除计时器重新计时。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">debounce</span>(<span class="params">fn, delay, immediate</span>) {</span><br><span class="line">  <span class="keyword">let</span> timer, result;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> debounced = <span class="keyword">function</span> (<span class="params">...args</span>) {</span><br><span class="line">    <span class="keyword">const</span> context = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    <span class="comment">//第一次触发时立即执行</span></span><br><span class="line">    <span class="keyword">if</span> (immediate) {</span><br><span class="line">      <span class="keyword">const</span> callNow = !timer;</span><br><span class="line">      timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        timer = <span class="literal">null</span>;</span><br><span class="line">      }, delay);</span><br><span class="line">      <span class="keyword">if</span> (callNow) result = fn.<span class="title function_">apply</span>(context, args);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      timer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">        fn.<span class="title function_">apply</span>(context, args);</span><br><span class="line">      }, delay);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  debounced.<span class="property">cancle</span> = <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    timer = <span class="literal">null</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> debounced;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="四、手写节流"><a href="#四、手写节流" class="headerlink" title="四、手写节流"></a>四、手写节流</h1><p>节流就是 n 秒内只会触发一次函数，也就是对节流函数定义一个计时器，计时器内重新触发不会生效。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//节流函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">throttle</span>(<span class="params">fn, delay, options</span>) {</span><br><span class="line">  <span class="keyword">let</span> timer,</span><br><span class="line">    context,</span><br><span class="line">    previous = <span class="number">0</span>,</span><br><span class="line">    args;</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    timer：保存 setTimeout id，用来取消最后一次补尾。</span></span><br><span class="line"><span class="comment">    context/args：缓存调用 throttled 时的 this 和实参，因为 later 里还要用。</span></span><br><span class="line"><span class="comment">    previous：上一次真正执行 func 的时间戳（初始 0 方便第一次判断）。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (!options) options = {};</span><br><span class="line">  <span class="keyword">const</span> later = <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="comment">//如果设置了 leading，则第一次调用时不需要等待 wait 时间。</span></span><br><span class="line">    previous = options.<span class="property">leading</span> === <span class="literal">false</span> ? <span class="number">0</span> : <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    timer = <span class="literal">null</span>;</span><br><span class="line">    fn.<span class="title function_">apply</span>(context, args);</span><br><span class="line">    context = args = <span class="literal">null</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> throttled = <span class="keyword">function</span> (<span class="params">..._args</span>) {</span><br><span class="line">    <span class="keyword">const</span> now = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line">    <span class="comment">/*如果 leading 被禁用，且是第一次调用，就把 previous 设为 now，相当于“第一次不算数”，</span></span><br><span class="line"><span class="comment">    要等到 delay 之后才允许第一次真正执行。*/</span></span><br><span class="line">    <span class="keyword">if</span> (!previous &amp;&amp; options.<span class="property">leading</span> === <span class="literal">false</span>) previous = now;</span><br><span class="line">    <span class="keyword">const</span> remaining = delay - (now - previous);</span><br><span class="line">    context = <span class="variable language_">this</span>;</span><br><span class="line">    args = _args;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*remaining &lt;= 0：说明离上一次执行已经超过 delay，可以立即执行。</span></span><br><span class="line"><span class="comment">      remaining &gt; delay：当系统时间被用户/浏览器回调拨回时会出现*/</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      ((options.<span class="property">leading</span> !== <span class="literal">false</span> || options.<span class="property">trailing</span> !== <span class="literal">false</span>) &amp;&amp;</span><br><span class="line">        remaining &lt;= <span class="number">0</span>) ||</span><br><span class="line">      remaining &gt; delay</span><br><span class="line">    ) {</span><br><span class="line">      <span class="keyword">if</span> (timer) {</span><br><span class="line">        <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">        timer = <span class="literal">null</span>;</span><br><span class="line">      }</span><br><span class="line">      previous = now;</span><br><span class="line">      fn.<span class="title function_">apply</span>(context, args);</span><br><span class="line">      <span class="keyword">if</span> (!timer) context = args = <span class="literal">null</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!timer &amp;&amp; options.<span class="property">trailing</span> !== <span class="literal">false</span>) {</span><br><span class="line">      <span class="comment">//如果没有定时器，且 trailing 被启用，则设置一个定时器，此为补尾</span></span><br><span class="line">      timer = <span class="built_in">setTimeout</span>(later, remaining);</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  throttled.<span class="property">cancle</span> = <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">if</span> (timer) <span class="built_in">clearTimeout</span>(timer);</span><br><span class="line">    previous = <span class="number">0</span>;</span><br><span class="line">    timer = <span class="literal">null</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> throttled;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">leading</th>
<th style="text-align:left">trailing</th>
<th style="text-align:left">行为描述（delay = 1000）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">true</td>
<td style="text-align:left">true</td>
<td style="text-align:left">默认：第一次立即执行，之后每 1000 ms 最多一次；快速结束后如果还有剩余时间，补尾再执行一次。</td>
</tr>
<tr>
<td style="text-align:left">true</td>
<td style="text-align:left">false</td>
<td style="text-align:left">只有第一次立即，后面全忽略（相当于 immediate-debounce）。</td>
</tr>
<tr>
<td style="text-align:left">false</td>
<td style="text-align:left">true</td>
<td style="text-align:left">第一次不执行，等 1000 ms 后才执行，之后每 1000 ms 一次；最后一次若有剩余时间还会补尾。</td>
</tr>
<tr>
<td style="text-align:left">false</td>
<td style="text-align:left">false</td>
<td style="text-align:left">什么也不执行（无意义）。</td>
</tr>
</tbody>
</table>
</div>
<h1 id="五、手写-bind"><a href="#五、手写-bind" class="headerlink" title="五、手写 bind"></a>五、手写 bind</h1><p>对于<code>bind()</code>方法 1.语法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun.<span class="title function_">bind</span>(thisArg, arg1, arg2,...)</span><br></pre></td></tr></table></figure>
<p>2.说明：</p>
<ul>
<li><code>thisArg</code>：在<code>fun</code>函数运行的时指定的<code>this</code>值。</li>
<li><code>arg1，arg2</code>：传递的其它参数。</li>
<li>返回由指定的<code>this</code>值和初始化参数改造的原函数拷贝（新函数）,即返回值是个函数。</li>
<li>只改变<code>this</code>指向，不调用函数。 3.例子</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//普通函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params"></span>) {</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line">}</span><br><span class="line"><span class="keyword">let</span> user = {</span><br><span class="line">  <span class="attr">name</span>: <span class="string">'小明'</span>,</span><br><span class="line"> <span class="attr">age</span>: <span class="number">18</span></span><br><span class="line">}</span><br><span class="line">​</span><br><span class="line"><span class="comment">//调用bind指定this的值</span></span><br><span class="line"><span class="keyword">let</span> sayHello = sayHi.<span class="title function_">bind</span>(user)</span><br><span class="line"><span class="title function_">sayHello</span>()</span><br></pre></td></tr></table></figure>
<p>所以我们自定义的<code>bind()</code>函数返回的是一个函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">bind</span> = <span class="keyword">function</span> (<span class="params">context, ...args</span>) {</span><br><span class="line">  <span class="comment">// Function原型对象的this指针指向调用bind的函数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span> !== <span class="string">"function"</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(</span><br><span class="line">      <span class="string">"Function.prototype.bind - what is trying to be bound is not callable"</span>,</span><br><span class="line">    );</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">const</span> fn = <span class="variable language_">this</span>; <span class="comment">//保存原函数</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="variable constant_">NOP</span> = <span class="keyword">function</span> (<span class="params"></span>) {}; <span class="comment">//空函数，用于创建原型链</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回一个新的函数，该函数在调用时会将this指向context，并预先传入args参数</span></span><br><span class="line">  <span class="keyword">const</span> bound = <span class="keyword">function</span> (<span class="params">...newArgs</span>) {</span><br><span class="line">    <span class="comment">//通过instanceof判断是否是通过new调用，因为new调用时this指向新创建的对象，新创建的对象会继承bound的原型</span></span><br><span class="line">    <span class="keyword">const</span> isNewCall = <span class="variable language_">this</span> <span class="keyword">instanceof</span> bound;</span><br><span class="line">    <span class="keyword">return</span> fn.<span class="title function_">apply</span>(</span><br><span class="line">      isNewCall ? <span class="variable language_">this</span> : context, <span class="comment">//如果是new调用，则this指向新创建的对象，否则指向context</span></span><br><span class="line">      args.<span class="title function_">concat</span>(newArgs), <span class="comment">//合并原有参数和新传入的参数</span></span><br><span class="line">    );</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="variable constant_">NOP</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="variable language_">this</span>.<span class="property"><span class="keyword">prototype</span></span>; <span class="comment">//设置原型链</span></span><br><span class="line">  bound.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title function_">NOP</span>(); <span class="comment">//创建一个新的空函数实例作为bound的原型</span></span><br><span class="line">  <span class="comment">/** bound.prototype -&gt; new NOP()</span></span><br><span class="line"><span class="comment">   *  new NOP().__protp__ -&gt; NOP.prototype</span></span><br><span class="line"><span class="comment">   *  NOP.prototype -&gt; this.prototype = fn.prototype</span></span><br><span class="line"><span class="comment">   *  new bound().__proto__ -&gt; bound.prototype</span></span><br><span class="line"><span class="comment">   *  确保了bound的实例可以访问fn的原型方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> bound; <span class="comment">//返回新的函数，该函数绑定了指定的this和初始参数</span></span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<h1 id="六、手写-call-和-apply"><a href="#六、手写-call-和-apply" class="headerlink" title="六、手写 call 和 apply"></a>六、手写 call 和 apply</h1><h2 id="对call-方法"><a href="#对call-方法" class="headerlink" title="对call()方法"></a>对<code>call()</code>方法</h2><p>1.语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun.<span class="title function_">call</span>(thisArg,arg1,arg2,...)</span><br></pre></td></tr></table></figure>
<p>2.说明：</p>
<ul>
<li><code>thisAr</code>g：在 fun 函数运行时指定的<code>this</code>值。</li>
<li><code>arg1，arg2</code>：传递的其他参数。</li>
<li>返回值就是函数的返回值，因为它就是调用函数。 3.例子</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = {</span><br><span class="line"> <span class="attr">name</span>: <span class="string">'pink'</span></span><br><span class="line">}</span><br><span class="line">​</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params"></span>) {</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line">}</span><br><span class="line">fn.<span class="title function_">call</span>(obj) <span class="comment">//指向obj{name: 'pink'}</span></span><br><span class="line">​</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fn1</span>(<span class="params">x,y</span>) {</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>)</span><br><span class="line"> <span class="variable language_">console</span>.<span class="title function_">log</span>(x+y)</span><br><span class="line">}</span><br><span class="line">fn1.<span class="title function_">call</span>(obj,<span class="number">1</span>,<span class="number">2</span>)  <span class="comment">//指向obj，返回1+2</span></span><br></pre></td></tr></table></figure>
<p>则：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">call</span> = <span class="keyword">function</span> (<span class="params">context, ...args</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span> !== <span class="string">"function"</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">"what is trying to be bound is not callable"</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ==处理 null / undefined -&gt; 全局对象（非严格模式）或 undefined（严格模式）</span></span><br><span class="line">  context = context == <span class="literal">null</span> ? globalThis : <span class="title class_">Object</span>(context);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fnKey = <span class="title class_">Symbol</span>(<span class="string">"__fn__"</span>); <span class="comment">// 唯一 key，防止属性冲突</span></span><br><span class="line">  context[fnKey] = <span class="variable language_">this</span>; <span class="comment">// 把当前函数挂到 context 上</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = context[fnKey](...args); <span class="comment">// 执行并传参</span></span><br><span class="line">  <span class="keyword">delete</span> context[fnKey];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<h2 id="对apply-方法"><a href="#对apply-方法" class="headerlink" title="对apply()方法"></a>对<code>apply()</code>方法</h2><p>1.语法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun.<span class="title function_">apply</span>(thisArg,[argsArray])</span><br></pre></td></tr></table></figure>
<p>2.说明：</p>
<ul>
<li><code>thisArg</code>：在<code>fun</code>函数运行时指定的<code>this</code>的值。</li>
<li><code>argsArray</code>：传递的值，必须包含在数组里。</li>
<li>返回值就是函数的返回值，因为它是调用函数。</li>
<li><code>apply</code>主要跟数组有关。 3.例子</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">counter</span>(<span class="params">x, y</span>) {</span><br><span class="line">  <span class="keyword">return</span> x+y</span><br><span class="line">}</span><br><span class="line"><span class="comment">//调用counter函数，并传入参数</span></span><br><span class="line"><span class="keyword">let</span> res = counter.<span class="title function_">appy</span>(<span class="literal">null</span>,[<span class="number">5</span>,<span class="number">10</span>])</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res)  <span class="comment">//15</span></span><br></pre></td></tr></table></figure>
<p>4.求数组最大值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">3</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">9</span>]</span><br><span class="line"><span class="comment">//展开运算符求</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Math</span>.<span class="title function_">max</span>(...arr))  <span class="comment">//9</span></span><br><span class="line"><span class="comment">//apply(求)</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Math</span>.<span class="property">max</span>.<span class="title function_">apply</span>(<span class="literal">null</span>,arr))  <span class="comment">//9</span></span><br></pre></td></tr></table></figure>
<p>则：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">apply</span> = <span class="keyword">function</span> (<span class="params">context, arr = []</span>) {</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="variable language_">this</span> !== <span class="string">"function"</span>) {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(</span><br><span class="line">      <span class="string">"Function.prototype.apply - what is trying to be bound is not callable"</span>,</span><br><span class="line">    );</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理 null / undefined</span></span><br><span class="line">  context = context == <span class="literal">null</span> ? globalThis : <span class="title class_">Object</span>(context);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fnKey = <span class="title class_">Symbol</span>(<span class="string">"__fn__"</span>);</span><br><span class="line">  context[fnKey] = <span class="variable language_">this</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = context[fnKey](...arr); <span class="comment">// 展开数组</span></span><br><span class="line">  <span class="keyword">delete</span> context[fnKey];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<h1 id="七、手写-EventBus"><a href="#七、手写-EventBus" class="headerlink" title="七、手写 EventBus"></a>七、手写 EventBus</h1><p>EventBus，即事件总线，如下<br><img src="/images/8.31edit/Pasted-image-20250810010740.png" alt=""><br>一般来说要实现 on(订阅事件-一直监听)，emit(发布事件-触发)，once(一次性订阅-监听一次)，off(取消订阅-取消监听)，clear(清空事件)。<br>考虑到时间性能，我们可以用哈希表存储事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventBus</span> {</span><br><span class="line">  <span class="comment">//#为私有变量</span></span><br><span class="line">  #events = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">  #id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 订阅，将事件推入监听表 */</span></span><br><span class="line">  <span class="title function_">on</span>(<span class="params">name, fn</span>) {</span><br><span class="line">    <span class="keyword">const</span> id = ++<span class="variable language_">this</span>.#id;</span><br><span class="line">    (<span class="variable language_">this</span>.#events[name] ||= <span class="keyword">new</span> <span class="title class_">Map</span>()).<span class="title function_">set</span>(id, fn);</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 发布，触发监听表里的指定事件 */</span></span><br><span class="line">  <span class="title function_">emit</span>(<span class="params">name, ...args</span>) {</span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="variable language_">this</span>.#events[name];</span><br><span class="line">    <span class="keyword">if</span> (!listeners) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> [id, fn] <span class="keyword">of</span> listeners) {</span><br><span class="line">      <span class="comment">//保证个别事件出错不会影响其他事件触发</span></span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">        <span class="title function_">fn</span>(...args);</span><br><span class="line">      } <span class="keyword">catch</span> (_) {}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 一次性订阅，封装为触发后取消监听 */</span></span><br><span class="line">  <span class="title function_">once</span>(<span class="params">name, fn</span>) {</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">wrap</span> = (<span class="params">...args</span>) =&gt; {</span><br><span class="line">      <span class="title function_">fn</span>(...args);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">off</span>(name, id);</span><br><span class="line">    };</span><br><span class="line">    <span class="keyword">const</span> id = <span class="variable language_">this</span>.<span class="title function_">on</span>(name, wrap);</span><br><span class="line">    <span class="keyword">return</span> id;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 移除监听 */</span></span><br><span class="line">  <span class="title function_">off</span>(<span class="params">name, id</span>) {</span><br><span class="line">    <span class="keyword">const</span> listeners = <span class="variable language_">this</span>.#events[name];</span><br><span class="line">    <span class="keyword">if</span> (!listeners) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> removed = listeners.<span class="title function_">delete</span>(id);</span><br><span class="line">    <span class="keyword">if</span> (!listeners.<span class="property">size</span>) <span class="keyword">delete</span> <span class="variable language_">this</span>.#events[name];</span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 清空某类或全部 */</span></span><br><span class="line">  <span class="title function_">clear</span>(<span class="params">name</span>) {</span><br><span class="line">    <span class="keyword">if</span> (name) <span class="keyword">delete</span> <span class="variable language_">this</span>.#events[name];</span><br><span class="line">    <span class="keyword">else</span> <span class="variable language_">this</span>.#events = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="八、手写数组扁平化函数"><a href="#八、手写数组扁平化函数" class="headerlink" title="八、手写数组扁平化函数"></a>八、手写数组扁平化函数</h1><p>这个好理解，就是不断把数组展开<br><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/flatten-deeply-nested-array/description/">2625. 扁平化嵌套数组 - 力扣（LeetCode）</a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">flatten</span> = (<span class="params">input, shallow = <span class="literal">false</span>, strict = <span class="literal">false</span>, output = []</span>) =&gt; {</span><br><span class="line">  <span class="keyword">let</span> nextIdx = output.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> value <span class="keyword">of</span> input) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) {</span><br><span class="line">      <span class="keyword">if</span> (shallow) {</span><br><span class="line">        <span class="comment">// 只扁平一层，直接批量 push</span></span><br><span class="line">        output.<span class="title function_">push</span>(...value);</span><br><span class="line">        nextIdx = output.<span class="property">length</span>;</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="title function_">flatten</span>(value, shallow, strict, output);</span><br><span class="line">        nextIdx = output.<span class="property">length</span>;</span><br><span class="line">      }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!strict) {</span><br><span class="line">      <span class="comment">// 非严格模式，直接 push</span></span><br><span class="line">      output[nextIdx++] = value;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> output;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<p>指定递归层数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">flatten</span> = (<span class="params">input, depth = <span class="number">1</span>, output = []</span>) =&gt; {</span><br><span class="line">  <span class="keyword">let</span> idx = output.<span class="property">length</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = input.<span class="property">length</span>; i &lt; len; i++) {</span><br><span class="line">    <span class="keyword">const</span> value = input[i];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value) &amp;&amp; depth &gt; <span class="number">0</span>) {</span><br><span class="line">      <span class="title function_">flatten</span>(value, depth - <span class="number">1</span>, output);</span><br><span class="line">      idx = output.<span class="property">length</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      output[idx++] = value;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> output;</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<h1 id="九、手写红绿灯"><a href="#九、手写红绿灯" class="headerlink" title="九、手写红绿灯"></a>九、手写红绿灯</h1><p>主要用 Promise 模拟红绿灯变化</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">red</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"red"</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">green</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"green"</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">yellow</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">"yellow"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">light</span> = (<span class="params">cb, wait</span>) =&gt;</span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="title function_">cb</span>();</span><br><span class="line">      <span class="title function_">resolve</span>();</span><br><span class="line">    }, wait),</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">start</span> = (<span class="params"></span>) =&gt;</span><br><span class="line">  <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title function_">light</span>(red, <span class="number">1000</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title function_">light</span>(green, <span class="number">1000</span>))</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="title function_">light</span>(yellow, <span class="number">1000</span>))</span><br><span class="line">    .<span class="title function_">finally</span>(start);</span><br><span class="line"></span><br><span class="line"><span class="title function_">start</span>();</span><br></pre></td></tr></table></figure>
<h1 id="十、手写-Promise"><a href="#十、手写-Promise" class="headerlink" title="十、手写 Promise"></a>十、手写 Promise</h1><p>对于 Promise：</p>
<ul>
<li>有三种状态，<code>pending</code>，<code>fullfilled</code>和<code>rejected</code>，所以我们需要一个<code>promiseState</code>字段来判断状态，其中：<ul>
<li>执行了<code>resolve</code>，Promise 状态会变成<code>fulfilled</code></li>
<li>执行了<code>reject</code>，Promise 状态会变成<code>rejected</code></li>
<li>Promise 只以<code>第一次为准</code>，第一次成功就<code>永久</code>为<code>fulfilled</code>，第一次失败就永远状态为<code>rejected</code></li>
<li>Promise 中有<code>throw</code>的话，就相当于执行了<code>reject</code></li>
</ul>
</li>
<li>然后由于函数调用会随着调用环境改变<code>this</code>指针的方向，所以我们要锁定<code>resolve</code>和<code>reject</code>的<code>this</code>指针方向始终指向当前对象，这可以用<code>bind</code>。</li>
<li>对于 then：<ul>
<li>接收两个回调，一个是<code>成功回调</code>，一个是<code>失败回调</code></li>
<li>当 Promise 状态为<code>fulfilled</code>执行<code>成功回调</code>，为<code>rejected</code>执行<code>失败回调</code></li>
<li>若<code>resolve</code>或<code>reject</code>在定时器里，<code>则定时器结束后再执行then</code></li>
<li>then 支持<code>链式调用</code>，下一次 then 执行<code>受上一次then返回值的影响</code></li>
<li>then 本质是返回一个新的 promise 对象</li>
<li>then 为微任务</li>
</ul>
</li>
<li>对于 then 返回的新 promise 对象： - 如果返回值是 promise 对象，返回值为成功，新 promise 就是成功 - 如果返回值是 promise 对象，返回值为失败，新 promise 就是失败 - 如果返回值非 promise 对象，新 promise 对象就是成功，值为此返回值<br>则：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyPromise</span> {</span><br><span class="line">  promiseState = <span class="string">"pending"</span>;</span><br><span class="line">  promiseResult = <span class="literal">null</span>;</span><br><span class="line">  <span class="comment">//处理计时器情况</span></span><br><span class="line">  onFulfilledCallbacks = []; <span class="comment">//成功回调函数队列</span></span><br><span class="line">  onRejectedCallbacks = []; <span class="comment">//失败回调函数队列</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">executor</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> executor !== <span class="string">"function"</span>) {</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">"Promise resolver is not a function"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">initialBound</span>(); <span class="comment">//绑定this</span></span><br><span class="line">    <span class="comment">//处理throw情况</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="title function_">executor</span>(<span class="variable language_">this</span>.<span class="property">resolve</span>, <span class="variable language_">this</span>.<span class="property">reject</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (error) {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reject</span>(error);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="title function_">initialBound</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">resolve</span> = <span class="variable language_">this</span>.<span class="property">resolve</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">reject</span> = <span class="variable language_">this</span>.<span class="property">reject</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="params">value</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">promiseState</span> !== <span class="string">"pending"</span>) <span class="keyword">return</span>; <span class="comment">//保证锁状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">promiseState</span> = <span class="string">"fulfilled"</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">promiseResult</span> = value;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">onFulfilledCallbacks</span>.<span class="property">length</span>) {</span><br><span class="line">      <span class="keyword">const</span> callback = <span class="variable language_">this</span>.<span class="property">onFulfilledCallbacks</span>.<span class="title function_">shift</span>();</span><br><span class="line">      <span class="title function_">callback</span>(value);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="title function_">reject</span>(<span class="params">reason</span>) {</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">promiseState</span> !== <span class="string">"pending"</span>) <span class="keyword">return</span>; <span class="comment">//保证锁状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">promiseState</span> = <span class="string">"rejected"</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">promiseResult</span> = reason;</span><br><span class="line">    <span class="keyword">while</span> (<span class="variable language_">this</span>.<span class="property">onRejectedCallbacks</span>.<span class="property">length</span>) {</span><br><span class="line">      <span class="keyword">const</span> callback = <span class="variable language_">this</span>.<span class="property">onRejectedCallbacks</span>.<span class="title function_">shift</span>();</span><br><span class="line">      <span class="title function_">callback</span>(reason);</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="title function_">then</span>(<span class="params">onFulfilled, onRejected</span>) {</span><br><span class="line">    <span class="comment">//处理非函数情况</span></span><br><span class="line">    onFulfilled =</span><br><span class="line">      <span class="keyword">typeof</span> onFulfilled === <span class="string">"function"</span> ? onFulfilled : <span class="function">(<span class="params">value</span>) =&gt;</span> value;</span><br><span class="line">    onRejected =</span><br><span class="line">      <span class="keyword">typeof</span> onRejected === <span class="string">"function"</span></span><br><span class="line">        ? onRejected</span><br><span class="line">        : <span class="function">(<span class="params">reason</span>) =&gt;</span> {</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">          };</span><br><span class="line"></span><br><span class="line">    <span class="comment">//返回一个新的Promise对象</span></span><br><span class="line">    <span class="keyword">const</span> thenPromise = <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">const</span> <span class="title function_">resolvePromise</span> = (<span class="params">cb</span>) =&gt; {</span><br><span class="line">        <span class="comment">//使用setTimeout模拟异步</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">const</span> result = <span class="title function_">cb</span>(<span class="variable language_">this</span>.<span class="property">promiseResult</span>);</span><br><span class="line">            <span class="comment">//处理循环引用</span></span><br><span class="line">            <span class="keyword">if</span> (result === thenPromise) {</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(</span><br><span class="line">                <span class="string">"Chaining cycle detected for promise #&lt;MyPromise&gt;"</span>,</span><br><span class="line">              );</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">if</span> (result <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) {</span><br><span class="line">              <span class="comment">//如果返回的是Promise，继续等待其状态改变</span></span><br><span class="line">              result.<span class="title function_">then</span>(resolve, reject);</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">              <span class="comment">//否则直接resolve</span></span><br><span class="line">              <span class="title function_">resolve</span>(result);</span><br><span class="line">            }</span><br><span class="line">          } <span class="keyword">catch</span> (error) {</span><br><span class="line">            <span class="title function_">reject</span>(error);</span><br><span class="line">          }</span><br><span class="line">        });</span><br><span class="line">      };</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">promiseState</span> === <span class="string">"fulfilled"</span>) {</span><br><span class="line">        <span class="title function_">resolvePromise</span>(onFulfilled);</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">promiseState</span> === <span class="string">"rejected"</span>) {</span><br><span class="line">        <span class="title function_">resolvePromise</span>(onRejected);</span><br><span class="line">      }</span><br><span class="line">      <span class="comment">//resolve和reject在计时器中未被调用时，推入队列等待调用</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">promiseState</span> === <span class="string">"pending"</span>) {</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onFulfilledCallbacks</span>.<span class="title function_">push</span>(resolvePromise.<span class="title function_">bind</span>(<span class="variable language_">this</span>, onFulfilled));</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onRejectedCallbacks</span>.<span class="title function_">push</span>(resolvePromise.<span class="title function_">bind</span>(<span class="variable language_">this</span>, onRejected));</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> thenPromise;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="十一、手写-Promise-all-和-Promise-any"><a href="#十一、手写-Promise-all-和-Promise-any" class="headerlink" title="十一、手写 Promise.all 和 Promise.any"></a>十一、手写 Promise.all 和 Promise.any</h1><p>all 即接受一个 Promise 数组：</p>
<ul>
<li>所有 Promise 成功，返回成功数组。</li>
<li>有一个 Promise 失败，返回失败结果。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">all</span>(<span class="params">promises</span>) {</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">let</span> completedCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//返回一个新的Promise对象，以所有子Promise的状态决定最终状态</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">      promises.<span class="title function_">forEach</span>(<span class="function">(<span class="params">promise, index</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (promise <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) {</span><br><span class="line">          promise.<span class="title function_">then</span>(</span><br><span class="line">            <span class="function">(<span class="params">value</span>) =&gt;</span> {</span><br><span class="line">              results[index] = value;</span><br><span class="line">              completedCount++;</span><br><span class="line">              <span class="comment">//所有子Promise都完成时，resolve最终结果</span></span><br><span class="line">              <span class="keyword">if</span> (completedCount === promises.<span class="property">length</span>) {</span><br><span class="line">                <span class="title function_">resolve</span>(results);</span><br><span class="line">              }</span><br><span class="line">            },</span><br><span class="line">            <span class="comment">//某个子Promise失败时，reject最终结果</span></span><br><span class="line">            <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="title function_">reject</span>(err)</span><br><span class="line">          );</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">          <span class="comment">//处理非Promise情况，直接作为成功结果</span></span><br><span class="line">          results[index] = promise;</span><br><span class="line">          completedCount++;</span><br><span class="line">          <span class="keyword">if</span> (completedCount === promises.<span class="property">length</span>) {</span><br><span class="line">            <span class="title function_">resolve</span>(results);</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line">    });</span><br><span class="line">  }</span><br></pre></td></tr></table></figure>
<p>any 与 all 相反</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">any</span>(<span class="params">promises</span>) {</span><br><span class="line">  <span class="comment">//返回一个新的Promise对象，与all相反</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> errors = [];</span><br><span class="line">    <span class="keyword">let</span> completedCount = <span class="number">0</span>;</span><br><span class="line">    promises.<span class="title function_">forEach</span>(<span class="function">(<span class="params">promise</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (promise <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) {</span><br><span class="line">        promise.<span class="title function_">then</span>(</span><br><span class="line">          <span class="function">(<span class="params">value</span>) =&gt;</span> <span class="title function_">resolve</span>(value),</span><br><span class="line">          <span class="function">(<span class="params">err</span>) =&gt;</span> {</span><br><span class="line">            errors.<span class="title function_">push</span>(err);</span><br><span class="line">            completedCount++;</span><br><span class="line">            <span class="comment">//如果所有子Promise都失败，reject最终结果</span></span><br><span class="line">            <span class="keyword">if</span> (completedCount === promises.<span class="property">length</span>) {</span><br><span class="line">              <span class="title function_">reject</span>(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AggregateError</span>(errors, <span class="string">"All promises were rejected"</span>)</span><br><span class="line">              );</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        );</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="十二、手写-Promise-race"><a href="#十二、手写-Promise-race" class="headerlink" title="十二、手写 Promise.race"></a>十二、手写 Promise.race</h1><ul>
<li>接收一个 Promise 数组，数组中如有非 Promise 项，则此项当做成功</li>
<li>哪个 Promise 最快得到结果，就返回那个结果，无论成功失败</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">race</span>(<span class="params">promises</span>) {</span><br><span class="line">  <span class="comment">//返回一个新的Promise对象，以第一个完成的子Promise的状态决定最终状态</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    promises.<span class="title function_">forEach</span>(<span class="function">(<span class="params">promise</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (promise <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) {</span><br><span class="line">        promise.<span class="title function_">then</span>(</span><br><span class="line">          <span class="function">(<span class="params">res</span>) =&gt;</span> <span class="title function_">resolve</span>(res),</span><br><span class="line">          <span class="function">(<span class="params">err</span>) =&gt;</span> <span class="title function_">reject</span>(err)</span><br><span class="line">        );</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="title function_">resolve</span>(promise); <span class="comment">//处理非Promise情况，直接作为成功结果</span></span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="十三、手写-Promise-allSettled"><a href="#十三、手写-Promise-allSettled" class="headerlink" title="十三、手写 Promise.allSettled"></a>十三、手写 Promise.allSettled</h1><ul>
<li>接收一个 Promise 数组，数组中如有非 Promise 项，则此项当做成功</li>
<li>把每一个 Promise 的结果，集合成数组，返回</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="title function_">allSettled</span>(<span class="params">promises</span>) {</span><br><span class="line">  <span class="keyword">const</span> results = [];</span><br><span class="line">  <span class="keyword">let</span> completedCount = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">//把所有子Promise的结果都收集起来</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPromise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">handleResult</span> = (<span class="params">index, result</span>) =&gt; {</span><br><span class="line">      results[index] = result;</span><br><span class="line">      completedCount++;</span><br><span class="line">      <span class="comment">//所有子Promise都完成时，resolve最终结果</span></span><br><span class="line">      <span class="keyword">if</span> (completedCount === promises.<span class="property">length</span>) {</span><br><span class="line">        <span class="title function_">resolve</span>(results);</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line">    promises.<span class="title function_">forEach</span>(<span class="function">(<span class="params">promise, index</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">if</span> (promise <span class="keyword">instanceof</span> <span class="title class_">MyPromise</span>) {</span><br><span class="line">        promise.<span class="title function_">then</span>(</span><br><span class="line">          <span class="function">(<span class="params">value</span>) =&gt;</span> {</span><br><span class="line">            <span class="title function_">handleResult</span>(index, { <span class="attr">status</span>: <span class="string">"fulfilled"</span>, value });</span><br><span class="line">          },</span><br><span class="line">          <span class="function">(<span class="params">reason</span>) =&gt;</span> {</span><br><span class="line">            <span class="title function_">handleResult</span>(index, { <span class="attr">status</span>: <span class="string">"rejected"</span>, reason });</span><br><span class="line">          }</span><br><span class="line">        );</span><br><span class="line">      } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//处理非Promise情况，直接作为成功结果</span></span><br><span class="line">        <span class="title function_">handleResult</span>(index, { <span class="attr">status</span>: <span class="string">"fulfilled"</span>, <span class="attr">value</span>: promise });</span><br><span class="line">      }</span><br><span class="line">    });</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="十四、手写睡眠函数"><a href="#十四、手写睡眠函数" class="headerlink" title="十四、手写睡眠函数"></a>十四、手写睡眠函数</h1><p><a target="_blank" rel="noopener" href="https://leetcode.cn/problems/sleep/description/">2621. 睡眠函数 - 力扣（LeetCode）</a><br>力扣这个一行就能解决：就是利用异步编程使函数执行延迟一定时间，不影响主线程。<br>如下：await 会等待 Promise 状态置为 fullfilled 后才会继续进行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> {<span class="type">number</span>} <span class="variable">millis</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> {<span class="type">Promise</span>}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sleep</span>(<span class="params">millis</span>) {</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> <span class="built_in">setTimeout</span>(res, millis));</span><br><span class="line">}</span><br><span class="line">或;</span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">sleep</span>(<span class="params">millis</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">      <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="title function_">res</span>(<span class="number">5</span>), millis);</span><br><span class="line">    } <span class="keyword">catch</span> (err) {</span><br><span class="line">      <span class="title function_">rej</span>(err);</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * let t = Date.now()</span></span><br><span class="line"><span class="comment"> * sleep(100).then(() =&gt; console.log(Date.now() - t)) // 100</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<p>我们要实现的核心也在睡眠函数这一步，主要实现以下结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">LazyMan</span>(<span class="string">"Tony"</span>).<span class="title function_">eat</span>(<span class="string">"breakfast"</span>).<span class="title function_">sleep</span>(<span class="number">3</span>).<span class="title function_">eat</span>(<span class="string">"lunch"</span>).<span class="title function_">sleep</span>(<span class="number">1</span>).<span class="title function_">eat</span>(<span class="string">"dinner"</span>);</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// Hi I am Tony</span></span><br><span class="line"><span class="comment">// I am eating breakfast</span></span><br><span class="line"><span class="comment">// 等待3秒...</span></span><br><span class="line"><span class="comment">// I am eating lunch</span></span><br><span class="line"><span class="comment">// 等待1秒...</span></span><br><span class="line"><span class="comment">// I am eating dinner</span></span><br></pre></td></tr></table></figure>
<p>实现一个 LazyMan，有吃、睡等动作，睡顾名思义就要实现睡眠函数的效果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">LazyMan</span> {</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">name</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tasks</span> = [];</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Hi, I am <span class="subst">${<span class="variable language_">this</span>.name}</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">    });</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">runTasks</span>();</span><br><span class="line">    }, <span class="number">0</span>); <span class="comment">// 确保任务队列在所有任务添加后执行</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">runTasks</span>(<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> task <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">tasks</span>) {</span><br><span class="line">      <span class="keyword">await</span> <span class="title function_">task</span>();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="title function_">eat</span>(<span class="params">food</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`I am eating <span class="subst">${food}</span>`</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>();</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>; <span class="comment">// 返回this以支持链式调用</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="title function_">sleep</span>(<span class="params">time</span>) {</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">tasks</span>.<span class="title function_">push</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> {</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`I slept for <span class="subst">${time}</span> seconds`</span>);</span><br><span class="line">          <span class="title function_">resolve</span>();</span><br><span class="line">        }, time * <span class="number">1000</span>);</span><br><span class="line">      });</span><br><span class="line">    });</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>; <span class="comment">// 返回this以支持链式调用</span></span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createLazyMan</span>(<span class="params">name</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMan</span>(name);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="十五、手写-curry-函数，实现函数柯里化"><a href="#十五、手写-curry-函数，实现函数柯里化" class="headerlink" title="十五、手写 curry 函数，实现函数柯里化"></a>十五、手写 curry 函数，实现函数柯里化</h1><p>首先得知道什么是函数柯里化：</p>
<ul>
<li><code>柯里化（Currying）</code>是一种关于函数的高阶技术。它不仅被用于  JavaScript，还被用于其他编程语言。</li>
<li>柯里化是一种函数的转换，它是指将一个函数从可调用的  <code>f(a, b, c)</code>  转换为可调用的  <code>f(a)(b)(c)</code>。</li>
<li>柯里化不会调用函数。它只是对函数进行转换。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">curry</span>(<span class="params">func</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">curried</span>(<span class="params">...args</span>) {</span><br><span class="line">    <span class="comment">//如果参数足够，直接执行</span></span><br><span class="line">    <span class="keyword">if</span> (args.<span class="property">length</span> &gt;= func.<span class="property">length</span>) {</span><br><span class="line">      <span class="keyword">return</span> func.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">      <span class="comment">//否则返回一个新函数，继续收集参数</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">...newArgs</span>) {</span><br><span class="line">        <span class="keyword">return</span> curried.<span class="title function_">apply</span>(<span class="variable language_">this</span>, args.<span class="title function_">concat</span>(newArgs));</span><br><span class="line">      };</span><br><span class="line">    }</span><br><span class="line">  };</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>一行解决版本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">curry</span> = (<span class="params">fn, arity = fn.length</span>) =&gt; { <span class="keyword">const</span> <span class="title function_">curried</span> = (<span class="params">...args</span>) =&gt; (args.<span class="property">length</span> &gt;= arity ? <span class="title function_">fn</span>(...args) : <span class="function">(<span class="params">...more</span>) =&gt;</span> <span class="title function_">curried</span>(...args, ...more)) <span class="keyword">return</span> curried }</span><br></pre></td></tr></table></figure>
<h1 id="十六、手写-compose-函数"><a href="#十六、手写-compose-函数" class="headerlink" title="十六、手写 compose 函数"></a>十六、手写 compose 函数</h1><p>在计算机科学中，<strong>函数组合</strong>是将多个简单的函数，组合成一个更复杂的函数的行为或机制。每个函数的执行结果，作为参数传递给下一个函数，最后一个函数的执行结果就是整个函数的结果。相当于一个管道。<br>注意：</p>
<ol>
<li>compose 函数<strong>从右到左</strong>执行，而 pipe 函数从左到右执行</li>
<li>确保函数的输入输出类型匹配</li>
<li>处理异步操作时需要使用 async/await 版本</li>
<li>考虑错误处理机制</li>
<li>函数组合应该保持纯函数的特性<br>简单版：</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">compose</span>(<span class="params">...fns</span>) {</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">arg</span>) =&gt;</span> arg; <span class="comment">// 如果没有函数，返回一个恒等函数</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">return</span> fns[<span class="number">0</span>]; <span class="comment">// 如果只有一个函数，直接返回该函数</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fns.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">a</span>(<span class="title function_">b</span>(...args)); <span class="comment">// 组合函数，从右到左执行</span></span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>支持异步</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">composeAsync</span>(<span class="params">...fns</span>) {</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">arg</span>) =&gt;</span> arg; <span class="comment">// 如果没有函数，返回一个恒等函数</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">return</span> fns[<span class="number">0</span>]; <span class="comment">// 如果只有一个函数，直接返回该函数</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fns.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">async</span> (...args) =&gt; <span class="title function_">a</span>(<span class="keyword">await</span> <span class="title function_">b</span>(...args)); <span class="comment">// 组合函数，从右到左执行，等待异步结果</span></span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>从左到右的 pipe</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">pipe</span>(<span class="params">...fns</span>) {</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">arg</span>) =&gt;</span> arg; <span class="comment">// 如果没有函数，返回一个恒等函数</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">return</span> fns[<span class="number">0</span>]; <span class="comment">// 如果只有一个函数，直接返回该函数</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> fns.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> <span class="title function_">b</span>(<span class="title function_">a</span>(...args)); <span class="comment">// 组合函数，从左到右执行</span></span><br><span class="line">  });</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//等价于compose(...fns.reverse())</span></span><br></pre></td></tr></table></figure>
<p>支持错误处理的 compose</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">composeWithErrorHandling</span>(<span class="params">...fns</span>) {</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">0</span>) {</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">arg</span>) =&gt;</span> arg; <span class="comment">// 如果没有函数，返回一个恒等函数</span></span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">if</span> (fns.<span class="property">length</span> === <span class="number">1</span>) {</span><br><span class="line">    <span class="keyword">return</span> fns[<span class="number">0</span>]; <span class="comment">// 如果只有一个函数，直接返回该函数</span></span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> fns.<span class="title function_">reduce</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> {</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">a</span>(<span class="title function_">b</span>(...args)); <span class="comment">// 组合函数，从右到左执行</span></span><br><span class="line">      } <span class="keyword">catch</span> (error) {</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">"Error during function composition:"</span>, error);</span><br><span class="line">        <span class="keyword">throw</span> error;</span><br><span class="line">      }</span><br><span class="line">    };</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="十七、手写并发控制器"><a href="#十七、手写并发控制器" class="headerlink" title="十七、手写并发控制器"></a>十七、手写并发控制器</h1><p>假设有这么一个场景：现在有<code>20</code>个异步请求需要发送，但是由于某些原因，要求我们必须将同一时刻的并发请求数量控制在<code>3</code>个以内，并且还要尽可能快速的拿到响应结果。<br>在面试题中：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">实现一个并发请求函数<span class="title function_">concurrencyRequest</span>(urls, maxNum)，要求如下：</span><br><span class="line">• 要求最大并发数 maxNum</span><br><span class="line">• 每当有一个请求返回，就留下一个空位，可以增加新的请求</span><br><span class="line">• 所有请求完成后，结果按照 urls 里面的顺序依次打出（发送请求的函数可以直接使用fetch即可）</span><br></pre></td></tr></table></figure>
<p>也就是说，在同一时刻最多处理三个请求，完成的请求留出的空位可以给新的请求。<br>初看这道题，其实感觉跟小学同时只能烙两张饼、每面要烙 1 分钟、烙 3 张饼最少几分钟这题思想差不多。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">concurrencyRequest</span>(<span class="params">urls, maxNum</span>) {</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> {</span><br><span class="line">    <span class="keyword">const</span> results = [];</span><br><span class="line">    <span class="keyword">let</span> count = <span class="number">0</span>; <span class="comment">// 已完成的请求数量</span></span><br><span class="line">    <span class="keyword">let</span> index = <span class="number">0</span>; <span class="comment">// 当前请求的索引</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params"></span>) {</span><br><span class="line">      <span class="keyword">if</span> (index &gt;= urls.<span class="property">length</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      }</span><br><span class="line">      <span class="keyword">const</span> currentIndex = index; <span class="comment">// 保存当前请求的索引，定好位置</span></span><br><span class="line">      <span class="keyword">const</span> url = urls[index];</span><br><span class="line">      index++;</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url);</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> response.<span class="title function_">json</span>();</span><br><span class="line">        results[currentIndex] = data; <span class="comment">// 保存结果</span></span><br><span class="line">      } <span class="keyword">catch</span> (error) {</span><br><span class="line">        results[currentIndex] = { <span class="attr">error</span>: error.<span class="property">message</span> }; <span class="comment">// 保存错误信息</span></span><br><span class="line">      } <span class="keyword">finally</span> {</span><br><span class="line">        count++;</span><br><span class="line">        <span class="keyword">if</span> (count === urls.<span class="property">length</span>) {</span><br><span class="line">          <span class="title function_">resolve</span>(results); <span class="comment">// 所有请求完成，返回结果</span></span><br><span class="line">        }</span><br><span class="line">        <span class="title function_">request</span>(); <span class="comment">// 继续发起下一个请求</span></span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化并发请求，同步循环瞬间填满异步池子</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="title class_">Math</span>.<span class="title function_">min</span>(maxNum, urls.<span class="property">length</span>); i++) {</span><br><span class="line">      <span class="title function_">request</span>();</span><br><span class="line">    }</span><br><span class="line">  });</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h1 id="十八、手写-LRU-缓存"><a href="#十八、手写-LRU-缓存" class="headerlink" title="十八、手写 LRU 缓存"></a>十八、手写 LRU 缓存</h1><p>见算法修炼手册的链表专题。</p>
<h1 id="十九、手写useFetch"><a href="#十九、手写useFetch" class="headerlink" title="十九、手写useFetch()"></a>十九、手写useFetch()</h1><p>重点在于和abort结合</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> useFetch = <span class="keyword">function</span> (<span class="params">url</span>) {</span><br><span class="line">  <span class="keyword">const</span> [loading, setLoading] = <span class="title function_">useState</span>(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> [error, setError] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> controllerRef = <span class="title function_">useRef</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> {</span><br><span class="line">    <span class="keyword">if</span> (controllerRef.<span class="property">current</span>) {</span><br><span class="line">      controllerRef.<span class="property">current</span>.<span class="title function_">abort</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> controller = <span class="keyword">new</span> <span class="title class_">AbortController</span>();</span><br><span class="line">    controllerRef.<span class="property">current</span> = controller;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">fetch</span>(url, { <span class="attr">signal</span>: controller.<span class="property">signal</span> })</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (!res.<span class="property">ok</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">"Network error!"</span>);</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">json</span>();</span><br><span class="line">      })</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">data</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (!controller.<span class="property">signal</span>.<span class="property">aborted</span>) {</span><br><span class="line">          <span class="title function_">setData</span>(data);</span><br><span class="line">          <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">        }</span><br><span class="line">      })</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> {</span><br><span class="line">        <span class="keyword">if</span> (!controller.<span class="property">signal</span>.<span class="property">aborted</span>) {</span><br><span class="line">          <span class="title function_">setError</span>(error);</span><br><span class="line">          <span class="title function_">setLoading</span>(<span class="literal">false</span>);</span><br><span class="line">        }</span><br><span class="line">      });</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> controller.<span class="title function_">abort</span>();</span><br><span class="line">  }, [url]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> { data, loading, error };</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<h1 id="二十、手写getPrime"><a href="#二十、手写getPrime" class="headerlink" title="二十、手写getPrime()"></a>二十、手写getPrime()</h1><p>实现一个函数，每次调用时都输出下一个质数，实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getPrime = (<span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">  <span class="keyword">let</span> count = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">checkPrime</span> = (<span class="params">num</span>) =&gt; {</span><br><span class="line">    <span class="keyword">if</span> (num === <span class="number">2</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (num % <span class="number">2</span> === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">3</span>; i &lt;= <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">sqrt</span>(num)); i++) {</span><br><span class="line">      <span class="keyword">if</span> (num % i === <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  };</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line">    <span class="keyword">while</span> (!<span class="title function_">checkPrime</span>(count)) {</span><br><span class="line">      count++;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> count++;</span><br><span class="line">  };</span><br><span class="line">})();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">getPrime</span>()); <span class="comment">//2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">getPrime</span>()); <span class="comment">//3</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">getPrime</span>()); <span class="comment">//5</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">getPrime</span>()); <span class="comment">//7</span></span><br></pre></td></tr></table></figure>
<p>前提，在之后的分析中：</p>
<ul>
<li>把立即执行函数取名为func1</li>
<li>把返回的函数取名为func2</li>
</ul>
<p>然后我们来通过执行上下文来理解这个闭包函数是如何实现的。<br>首先，我们知道，执行上下文主要为以下三部分：</p>
<ul>
<li>变量对象(Variable object, VO, ES3)-&gt; 变量环境(VariableEnvironment，ES5+)</li>
<li>作用域链(Scope chain, ES3)-&gt; 词法环境(LexicalEnvironment，ES5+)</li>
<li>this<br>ES3和ES5+的说法不同，我们都说一遍：</li>
</ul>
<h3 id="1-ES3"><a href="#1-ES3" class="headerlink" title="1. ES3"></a>1. ES3</h3><p>两点注意：</p>
<ol>
<li>代码执行时，变量对象(VO)会自动变成活动对象(Active object，AO)，不过ES3时代没有let、const声明，写的话不好说，就全默认写成AO了。而且因为ES3时代没有let、const声明，所以实际上VO对象是变量提升和函数提升的声明绑定，这与之后ES5+的变量环境可以对应，不过还是说为了方便理解执行过程，我就只按照函数作用域来，更相当于ES5+模型词法环境中的EnvironmentRecord。</li>
<li>实际AO模型中，在执行时是<code>Scope:[AO(当前上下文的AO), [[scope]]]</code>，这与作用域链创建的时机有关(下文会说)，但为了方便说明，就全写成<code>[context.AO]</code>的形式。</li>
</ol>
<p>执行：初始化全局上下文：globalContext。<br>初始化执行栈：ECStack，推入全局上下文。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">globalContext = {</span><br><span class="line">	<span class="attr">AO</span>: {</span><br><span class="line">		<span class="attr">getPrime</span>: <span class="literal">undefined</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	[[scope]]: [globalContext.<span class="property">AO</span>];  <span class="comment">// 天然包含</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="title class_">ECStack</span> = [globalContext];</span><br></pre></td></tr></table></figure>
<p>对getPrime赋值，发现需要执行func1，所以首先进入func1，初始化func1的执行上下文并入栈，执行并出栈。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">func1Context = {</span><br><span class="line">	<span class="attr">AO</span>: {</span><br><span class="line">		<span class="attr">arguments</span>: { <span class="attr">length</span>: <span class="number">0</span> }</span><br><span class="line">		<span class="attr">count</span>: <span class="literal">undefined</span>;</span><br><span class="line">		<span class="attr">checkPrime</span>: &lt;<span class="keyword">function</span>&gt;;</span><br><span class="line">		<span class="comment">// func2: &lt;function&gt;;  // 返回值实际上不会在这里，我们为了方便理解，就写上</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	[[scope]]: [globalContext.<span class="property">AO</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="title class_">ECStack</span>.<span class="title function_">push</span>(func1Context) <span class="comment">// ECStack = [globalContext, func1Context]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行</span></span><br><span class="line">func1Context = {</span><br><span class="line">	<span class="attr">AO</span>: {</span><br><span class="line">		<span class="attr">arguments</span>: { <span class="attr">length</span>: <span class="number">0</span> };</span><br><span class="line">		<span class="attr">count</span>: <span class="number">2</span>;</span><br><span class="line">		<span class="attr">checkPrime</span>: check;</span><br><span class="line">		<span class="comment">// func2: func2;</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	[[scope]]: [func1Context.<span class="property">AO</span>, globalContext.<span class="property">AO</span>];  <span class="comment">// 自身的活动对象在执行时才会推入</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="variable language_">global</span>.<span class="property">AO</span>.<span class="property">getPrime</span> = func2;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ECStack</span>.<span class="title function_">pop</span>() <span class="comment">// ECStack = [globalContext]</span></span><br></pre></td></tr></table></figure>
<p>这里注意到，作用域链的创建时间：<strong>在函数创建时创建，而非调用时</strong>。因此执行赋值时还有两段：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">checkPrime.[[scope]] = [func1Context.<span class="property">AO</span>, globalContext.<span class="property">AO</span>];</span><br><span class="line">func2.[[scope]] = [func1Context.<span class="property">AO</span>, globalContext.<span class="property">AO</span>];</span><br></pre></td></tr></table></figure>
<p>可以看到func2的作用域链对func1的AO有引用，所以此时虽然func1的上下文出栈了，其AO并没有被销毁，count这个变量也就被保存了。而在之后，执行getPrime时，如下：<br>创建func2的上下文，进栈，执行，出栈：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化</span></span><br><span class="line">func2Context = {</span><br><span class="line">	<span class="attr">AO</span>: {</span><br><span class="line">		<span class="attr">arguments</span>: { <span class="attr">length</span>: <span class="number">0</span> };</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	[[scope]]: [func1Context.<span class="property">AO</span>, globalContext.<span class="property">AO</span>]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="title class_">ECStack</span>.<span class="title function_">push</span>(func2Context) <span class="comment">// ECStack = [globalContext, func2Context]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行</span></span><br><span class="line">func2Context = {</span><br><span class="line">	<span class="attr">AO</span>: {</span><br><span class="line">		<span class="attr">arguments</span>: { <span class="attr">length</span>: <span class="number">0</span> };</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	[[scope]]: [func2Context.<span class="property">AO</span>, func1Context.<span class="property">AO</span>, globalContext.<span class="property">AO</span>]</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于func1Context的AO始终未被销毁，所以有：</span></span><br><span class="line"><span class="comment">// 若为第一次返回2，执行完毕，此时func1Context.AO.count = 3</span></span><br><span class="line"><span class="comment">// 若为第二次返回3，执行完毕，此时func1Context.AO.count = 4</span></span><br><span class="line"><span class="comment">// 若为第三次返回5，执行完毕，此时func1Context.AO.count = 6</span></span><br><span class="line"><span class="comment">// 若为第四次返回7，执行完毕，此时func1Context.AO.count = 8</span></span><br><span class="line"><span class="title class_">ECStack</span>.<span class="title function_">pop</span>(); <span class="comment">// [globalContext];</span></span><br></pre></td></tr></table></figure>
<p>最后代码执行完毕，全局上下文出栈，getPrime被销毁，func2也被销毁，对func1.AO的引用没了，此时func1.AO才被销毁。</p>
<h3 id="2-ES5"><a href="#2-ES5" class="headerlink" title="2. ES5+"></a>2. ES5+</h3><p>对于ES5+的模型，按下面这样描述：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ExecutionContext</span> = {</span><br><span class="line">  <span class="title class_">LexicalEnvironment</span>     <span class="comment">// 词法环境，用于标识符解析，随作用域变化</span></span><br><span class="line">  <span class="title class_">VariableEnvironment</span>    <span class="comment">// 变量环境，用于变量声明绑定（var、function 声明），即变量提升的</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>而词法环境：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">LexicalEnvironment</span> = {</span><br><span class="line">  <span class="title class_">EnvironmentRecord</span>: { ... },  <span class="comment">// 所有在此作用域声明的绑定</span></span><br><span class="line">  <span class="title class_">Outer</span>: <span class="language-xml"><span class="tag">&lt;<span class="name">LexicalEnvironment</span> <span class="attr">or</span> <span class="attr">null</span>&gt;</span>  // 外层环境</span></span><br><span class="line"><span class="language-xml">}</span></span><br></pre></td></tr></table></figure>
<p>下面进行分析：<br>初始化全局上下文，进入执行上下文栈：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">globalContext = {</span><br><span class="line">	<span class="title class_">LexicalEnvironment</span>: LE_global;</span><br><span class="line">	<span class="title class_">VariableEnvironment</span>: LE_global;  <span class="comment">// 这里和下面都写成同样的是因为此题情况下没区别</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">LE_global = {</span><br><span class="line">	<span class="title class_">EnvironmentRecord</span>: {</span><br><span class="line">		<span class="attr">getPrime</span>: uninitialized;  <span class="comment">// const处于TDZ，暂时性死区</span></span><br><span class="line">	}</span><br><span class="line">	<span class="title class_">Outer</span>: <span class="literal">null</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="title class_">ECStack</span>.<span class="title function_">push</span>(globalContext) <span class="comment">// ECStack = [globalContext]</span></span><br></pre></td></tr></table></figure>
<p>执行赋值，发现需要执行func1，创建func1的执行上下文，进栈，执行，出栈：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">func1Context = {</span><br><span class="line">	<span class="title class_">LexicalEnvironment</span>: LE_func1;</span><br><span class="line">	<span class="title class_">VariableEnvironment</span>: LE_func1;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">LE_func1 = {</span><br><span class="line">	<span class="title class_">EnvironmentRecord</span>: {</span><br><span class="line">		<span class="attr">count</span>: uninitialized;</span><br><span class="line">		<span class="attr">checkPrime</span>: unintialized;</span><br><span class="line">		<span class="comment">// func2: unitialized; 实际返回值不会在这，还是便于理解才写上的</span></span><br><span class="line">	}</span><br><span class="line">	<span class="title class_">Outer</span>: globalLexicalEnvironment;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="title class_">ECStack</span>.<span class="title function_">push</span>(func1Context) <span class="comment">// ECStack = [globalContext, func1Context]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//执行</span></span><br><span class="line">LE_func1.<span class="property">EnvironmentRecord</span> = { <span class="attr">count</span>: <span class="number">2</span>, <span class="attr">checkPrime</span>: [<span class="title class_">Function</span> <span class="keyword">with</span> [[<span class="title class_">Environment</span>]] = LE_func1] }</span><br><span class="line"></span><br><span class="line">LE_global.<span class="property">EnvironmentRecord</span>.<span class="property">getPrime</span> = func2; <span class="comment">// func2.[[Environment]] = LE_func1;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">ECStack</span>.<span class="title function_">pop</span>() <span class="comment">// ECStack = [globalContext]</span></span><br></pre></td></tr></table></figure>
<p>同理，即使<code>func1Context</code>被弹出，但<code>LE_func1</code>仍被<code>func2.[[Environment]]</code>引用，所以不会被销毁。<br>然后执行getPrime，创建 func2 的执行上下文：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func2Context = {</span><br><span class="line">  <span class="title class_">LexicalEnvironment</span>: LE_func2,</span><br><span class="line">  <span class="title class_">VariableEnvironment</span>: LE_func2</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">LE_func2 = {</span><br><span class="line">  <span class="title class_">EnvironmentRecord</span>: { },</span><br><span class="line">  <span class="title class_">Outer</span>: func2.[[<span class="title class_">Environment</span>]]  <span class="comment">// 即LE_func1; 函数创建时捕获的词法环境</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">... <span class="comment">// 入栈、执行、出栈</span></span><br></pre></td></tr></table></figure>
<p>剩下的就跟ES3说的差不多了，不多赘述。</p>

      
    </div>
    <footer class="article-footer">
      
      
      
      
      
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item" data-aos="zoom-in"><a class="article-tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="article-tag-list-item" data-aos="zoom-in"><a class="article-tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95/" rel="tag">前端面试</a></li><li class="article-tag-list-item" data-aos="zoom-in"><a class="article-tag-list-link" href="/tags/%E7%BB%84%E4%BC%9A%E5%88%86%E4%BA%AB/" rel="tag">组会分享</a></li></ul>


    </footer>
  </div>
  
  <nav id="article-nav" data-aos="fade-up">
    
    
    <div class="article-nav-link-wrap article-nav-link-right">
      
        
        
          <img data-src="https://d-sketon.top/img/backimg/bg1.jpg" data-sizes="auto" alt="MCP: Model Context Protocol 模型上下文协议" class="lazyload">
        
      
      <a href="/2026/02/04/MCP/"></a>
      <div class="article-nav-caption">Older</div>
      <h3 class="article-nav-title">
        
          MCP: Model Context Protocol 模型上下文协议
        
      </h3>
    </div>
    
  </nav>


</article>






</section>
          
            <aside id="sidebar">
  <div class="sidebar-wrapper wrap-sticky">
    <div class="sidebar-wrap" data-aos="fade-up">
      
        <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.</span> <span class="toc-text">一、手写深拷贝</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%85%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.0.1.</span> <span class="toc-text">浅拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v1"><span class="toc-number">1.0.2.</span> <span class="toc-text">深拷贝 v1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v2"><span class="toc-number">1.0.3.</span> <span class="toc-text">深拷贝 v2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v3"><span class="toc-number">1.0.4.</span> <span class="toc-text">深拷贝 v3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v4"><span class="toc-number">1.0.5.</span> <span class="toc-text">深拷贝 v4</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%89%8B%E5%86%99%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">二、手写获取对象类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%89%8B%E5%86%99%E9%98%B2%E6%8A%96"><span class="toc-number">3.</span> <span class="toc-text">三、手写防抖</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%89%8B%E5%86%99%E8%8A%82%E6%B5%81"><span class="toc-number">4.</span> <span class="toc-text">四、手写节流</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%89%8B%E5%86%99-bind"><span class="toc-number">5.</span> <span class="toc-text">五、手写 bind</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%89%8B%E5%86%99-call-%E5%92%8C-apply"><span class="toc-number">6.</span> <span class="toc-text">六、手写 call 和 apply</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9call-%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">对call()方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9apply-%E6%96%B9%E6%B3%95"><span class="toc-number">6.2.</span> <span class="toc-text">对apply()方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%89%8B%E5%86%99-EventBus"><span class="toc-number">7.</span> <span class="toc-text">七、手写 EventBus</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%89%8B%E5%86%99%E6%95%B0%E7%BB%84%E6%89%81%E5%B9%B3%E5%8C%96%E5%87%BD%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">八、手写数组扁平化函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%89%8B%E5%86%99%E7%BA%A2%E7%BB%BF%E7%81%AF"><span class="toc-number">9.</span> <span class="toc-text">九、手写红绿灯</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E6%89%8B%E5%86%99-Promise"><span class="toc-number">10.</span> <span class="toc-text">十、手写 Promise</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E6%89%8B%E5%86%99-Promise-all-%E5%92%8C-Promise-any"><span class="toc-number">11.</span> <span class="toc-text">十一、手写 Promise.all 和 Promise.any</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E6%89%8B%E5%86%99-Promise-race"><span class="toc-number">12.</span> <span class="toc-text">十二、手写 Promise.race</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E6%89%8B%E5%86%99-Promise-allSettled"><span class="toc-number">13.</span> <span class="toc-text">十三、手写 Promise.allSettled</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E6%89%8B%E5%86%99%E7%9D%A1%E7%9C%A0%E5%87%BD%E6%95%B0"><span class="toc-number">14.</span> <span class="toc-text">十四、手写睡眠函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E6%89%8B%E5%86%99-curry-%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E6%9F%AF%E9%87%8C%E5%8C%96"><span class="toc-number">15.</span> <span class="toc-text">十五、手写 curry 函数，实现函数柯里化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%85%AD%E3%80%81%E6%89%8B%E5%86%99-compose-%E5%87%BD%E6%95%B0"><span class="toc-number">16.</span> <span class="toc-text">十六、手写 compose 函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%83%E3%80%81%E6%89%8B%E5%86%99%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">17.</span> <span class="toc-text">十七、手写并发控制器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%85%AB%E3%80%81%E6%89%8B%E5%86%99-LRU-%E7%BC%93%E5%AD%98"><span class="toc-number">18.</span> <span class="toc-text">十八、手写 LRU 缓存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B9%9D%E3%80%81%E6%89%8B%E5%86%99useFetch"><span class="toc-number">19.</span> <span class="toc-text">十九、手写useFetch()</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81%E3%80%81%E6%89%8B%E5%86%99getPrime"><span class="toc-number">20.</span> <span class="toc-text">二十、手写getPrime()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ES3"><span class="toc-number">20.0.1.</span> <span class="toc-text">1. ES3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ES5"><span class="toc-number">20.0.2.</span> <span class="toc-text">2. ES5+</span></a></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
        <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Tu Yuheng" class="lazyload">
  <div class="sidebar-author-name">Tu Yuheng</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">24</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">31</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">Home</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">Archives</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">About</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/friend" aria-label="Friend"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">Friend</div>
    </div>
  
</div>
</div>
      
      
        <div class="sidebar-btn-wrapper" style="position:static">
          <div class="sidebar-toc-btn current"></div>
          <div class="sidebar-common-btn"></div>
        </div>
      
    </div>
  </div>

  
</aside>

          
        </div>
        <footer id="footer">
  <div style="width: 100%; overflow: hidden">
    <div class="footer-line"></div>
  </div>
  <div id="footer-info">
    
    <div>
      <span class="icon-copyright"></span>
      2020-2026
      <span class="footer-info-sep"></span>
      Tu Yuheng
    </div>
    
      <div>
        Powered by&nbsp;<a href="https://hexo.io/" rel="noopener external nofollow noreferrer" target="_blank">Hexo</a>&nbsp;
        Theme.<a href="https://github.com/D-Sketon/hexo-theme-reimu" rel="noopener external nofollow noreferrer" target="_blank">Reimu</a>
      </div>
    
    
      <div>
        <span class="icon-brush"></span>
        97.3k
        &nbsp;|&nbsp;
        <span class="icon-coffee"></span>
        06:40
      </div>
    
    
    
    
      <div>
        <span class="icon-eye"></span>
        <span id="busuanzi_container_site_pv">Number of visits&nbsp;<span id="busuanzi_value_site_pv"></span></span>
        &nbsp;|&nbsp;
        <span class="icon-user"></span>
        <span id="busuanzi_container_site_uv">Number of visitors&nbsp;<span id="busuanzi_value_site_uv"></span></span>
      </div>
    
  </div>
</footer>

        <div class="sidebar-top">
          <img src="/images/taichi.png" height="50" width="50" alt="backtop" />
          <div class="arrow-up"></div>
        </div>
        <div id="mask"></div>
      </div>
      <nav id="mobile-nav">
  <div class="sidebar-wrap">
    
      <div class="sidebar-toc-sidebar"><div class="sidebar-toc">
  <h3 class="toc-title">Contents</h3>
  <div class="sidebar-toc-wrapper toc-div-class" >
      
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%89%8B%E5%86%99%E6%B7%B1%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.</span> <span class="toc-text">一、手写深拷贝</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%85%E6%8B%B7%E8%B4%9D"><span class="toc-number">1.0.1.</span> <span class="toc-text">浅拷贝</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v1"><span class="toc-number">1.0.2.</span> <span class="toc-text">深拷贝 v1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v2"><span class="toc-number">1.0.3.</span> <span class="toc-text">深拷贝 v2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v3"><span class="toc-number">1.0.4.</span> <span class="toc-text">深拷贝 v3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E6%8B%B7%E8%B4%9D-v4"><span class="toc-number">1.0.5.</span> <span class="toc-text">深拷贝 v4</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81%E6%89%8B%E5%86%99%E8%8E%B7%E5%8F%96%E5%AF%B9%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.</span> <span class="toc-text">二、手写获取对象类型</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%89%8B%E5%86%99%E9%98%B2%E6%8A%96"><span class="toc-number">3.</span> <span class="toc-text">三、手写防抖</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81%E6%89%8B%E5%86%99%E8%8A%82%E6%B5%81"><span class="toc-number">4.</span> <span class="toc-text">四、手写节流</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E6%89%8B%E5%86%99-bind"><span class="toc-number">5.</span> <span class="toc-text">五、手写 bind</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E6%89%8B%E5%86%99-call-%E5%92%8C-apply"><span class="toc-number">6.</span> <span class="toc-text">六、手写 call 和 apply</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9call-%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.</span> <span class="toc-text">对call()方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9apply-%E6%96%B9%E6%B3%95"><span class="toc-number">6.2.</span> <span class="toc-text">对apply()方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E6%89%8B%E5%86%99-EventBus"><span class="toc-number">7.</span> <span class="toc-text">七、手写 EventBus</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81%E6%89%8B%E5%86%99%E6%95%B0%E7%BB%84%E6%89%81%E5%B9%B3%E5%8C%96%E5%87%BD%E6%95%B0"><span class="toc-number">8.</span> <span class="toc-text">八、手写数组扁平化函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81%E6%89%8B%E5%86%99%E7%BA%A2%E7%BB%BF%E7%81%AF"><span class="toc-number">9.</span> <span class="toc-text">九、手写红绿灯</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81%E6%89%8B%E5%86%99-Promise"><span class="toc-number">10.</span> <span class="toc-text">十、手写 Promise</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%80%E3%80%81%E6%89%8B%E5%86%99-Promise-all-%E5%92%8C-Promise-any"><span class="toc-number">11.</span> <span class="toc-text">十一、手写 Promise.all 和 Promise.any</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81%E6%89%8B%E5%86%99-Promise-race"><span class="toc-number">12.</span> <span class="toc-text">十二、手写 Promise.race</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%89%E3%80%81%E6%89%8B%E5%86%99-Promise-allSettled"><span class="toc-number">13.</span> <span class="toc-text">十三、手写 Promise.allSettled</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%9B%9B%E3%80%81%E6%89%8B%E5%86%99%E7%9D%A1%E7%9C%A0%E5%87%BD%E6%95%B0"><span class="toc-number">14.</span> <span class="toc-text">十四、手写睡眠函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%BA%94%E3%80%81%E6%89%8B%E5%86%99-curry-%E5%87%BD%E6%95%B0%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%87%BD%E6%95%B0%E6%9F%AF%E9%87%8C%E5%8C%96"><span class="toc-number">15.</span> <span class="toc-text">十五、手写 curry 函数，实现函数柯里化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%85%AD%E3%80%81%E6%89%8B%E5%86%99-compose-%E5%87%BD%E6%95%B0"><span class="toc-number">16.</span> <span class="toc-text">十六、手写 compose 函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B8%83%E3%80%81%E6%89%8B%E5%86%99%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">17.</span> <span class="toc-text">十七、手写并发控制器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E5%85%AB%E3%80%81%E6%89%8B%E5%86%99-LRU-%E7%BC%93%E5%AD%98"><span class="toc-number">18.</span> <span class="toc-text">十八、手写 LRU 缓存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E4%B9%9D%E3%80%81%E6%89%8B%E5%86%99useFetch"><span class="toc-number">19.</span> <span class="toc-text">十九、手写useFetch()</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E5%8D%81%E3%80%81%E6%89%8B%E5%86%99getPrime"><span class="toc-number">20.</span> <span class="toc-text">二十、手写getPrime()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ES3"><span class="toc-number">20.0.1.</span> <span class="toc-text">1. ES3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ES5"><span class="toc-number">20.0.2.</span> <span class="toc-text">2. ES5+</span></a></li></ol></li></ol></li></ol>
      
  </div>
</div>
</div>
      <div class="sidebar-common-sidebar hidden"><div class="sidebar-author">
  <img data-src="/avatar/avatar.webp" data-sizes="auto" alt="Tu Yuheng" class="lazyload">
  <div class="sidebar-author-name">Tu Yuheng</div>
  <div class="sidebar-description"></div>
</div>
<div class="sidebar-state">
  <div class="sidebar-state-article">
    <div>Posts</div>
    <div class="sidebar-state-number">24</div>
  </div>
  <div class="sidebar-state-category">
    <div>Categories</div>
    <div class="sidebar-state-number">0</div>
  </div>
  <div class="sidebar-state-tag">
    <div>Tags</div>
    <div class="sidebar-state-number">31</div>
  </div>
</div>
<div class="sidebar-social">
  
</div>
<div class="sidebar-menu">
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/" aria-label="Home"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">Home</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/archives" aria-label="Archives"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">Archives</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/about" aria-label="About"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">About</div>
    </div>
  
    <div class="sidebar-menu-link-wrap">
      <a class="sidebar-menu-link-dummy" href="/friend" aria-label="Friend"></a>
      <div class="sidebar-menu-icon icon-taichi"></div>
      <div class="sidebar-menu-link">Friend</div>
    </div>
  
</div>
</div>
    
  </div>
  
    <div class="sidebar-btn-wrapper">
      <div class="sidebar-toc-btn current"></div>
      <div class="sidebar-common-btn"></div>
    </div>
  
</nav>

    </div>
    
    
<script src="https://npm.webcache.cn/lazysizes@5.3.2/lazysizes.min.js" integrity="sha384-3gT&#x2F;vsepWkfz&#x2F;ff7PpWNUeMzeWoH3cDhm&#x2F;A8jM7ouoAK0&#x2F;fP&#x2F;9bcHHR5kHq2nf+e" crossorigin="anonymous"></script>


<script src="https://npm.webcache.cn/clipboard@2.0.11/dist/clipboard.min.js" integrity="sha384-J08i8An&#x2F;QeARD9ExYpvphB8BsyOj3Gh2TSh1aLINKO3L0cMSH2dN3E22zFoXEi0Q" crossorigin="anonymous"></script>



<script src="/js/script.js"></script>



  
<script src="/js/aos.js"></script>

  <script>
    var aosInit = () => {
      AOS.init({
        duration: 1000,
        easing: "ease",
        once: true,
        offset: 50,
      });
    };
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', aosInit);
    } else {
      aosInit();
    }
  </script>



<script src="/js/pjax_script.js" data-pjax></script>







  
<script src="https://npm.webcache.cn/mouse-firework@0.0.6/dist/index.umd.js" integrity="sha384-vkGvf25gm1C1PbcoD5dNfc137HzNL&#x2F;hr1RKA5HniJOaawtvUmH5lTVFgFAruE9Ge" crossorigin="anonymous"></script>

  <script>
    window.firework && window.firework(JSON.parse('{"excludeElements":["a","button"],"particles":[{"shape":"circle","move":["emit"],"easing":"easeOutExpo","colors":["#ff5252","#ff7c7c","#ffafaf","#ffd0d0"],"number":20,"duration":[1200,1800],"shapeOptions":{"radius":[16,32],"alpha":[0.3,0.5]}},{"shape":"circle","move":["diffuse"],"easing":"easeOutExpo","colors":["#ff0000"],"number":1,"duration":[1200,1800],"shapeOptions":{"radius":20,"alpha":[0.2,0.5],"lineWidth":6}}]}'))
  </script>








<div id="lazy-script">
  <div>
    
    
      
        
<script src="/js/insert_highlight.js" data-pjax></script>

      
    
    
      <script type="module" data-pjax>
        const PhotoSwipeLightbox = (await safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe-lightbox.esm.min.js", "sha384-DiL6M/gG+wmTxmCRZyD1zee6lIhawn5TGvED0FOh7fXcN9B0aZ9dexSF/N6lrZi/")).default;
        
        const pswp = () => {
          if (_$$('.article-entry a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-entry',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          if(_$$('.article-gallery a.article-gallery-item').length > 0) {
            new PhotoSwipeLightbox({
              gallery: '.article-gallery',
              children: 'a.article-gallery-item',
              pswpModule: () => safeImport("https://npm.webcache.cn/photoswipe@5.4.4/dist/photoswipe.esm.min.js", "sha384-WkkO3GCmgkC3VQWpaV8DqhKJqpzpF9JoByxDmnV8+oTJ7m3DfYEWX1fu1scuS4+s")
            }).init();
          }
          window.lightboxStatus = 'done';
          window.removeEventListener('lightbox:ready', pswp);
        }
        if(window.lightboxStatus === 'ready') {
          pswp()
        } else {
          window.addEventListener('lightbox:ready', pswp);
        }
      </script>
      








    
  </div>
</div>


  <script>
    console.log(String.raw`%c 
 ______     ______     __     __    __     __  __    
/\  == \   /\  ___\   /\ \   /\ "-./  \   /\ \/\ \   
\ \  __<   \ \  __\   \ \ \  \ \ \-./\ \  \ \ \_\ \  
 \ \_\ \_\  \ \_____\  \ \_\  \ \_\ \ \_\  \ \_____\ 
  \/_/ /_/   \/_____/   \/_/   \/_/  \/_/   \/_____/ 
                                                  
`,'color: #ff5252;')
    console.log('%c Theme.Reimu v' + '0.3.5' + ' %c https://github.com/D-Sketon/hexo-theme-reimu ', 'color: white; background: #ff5252; padding:5px 0;', 'padding:4px;border:1px solid #ff5252;')
  </script>
  



  
<script src="https://npm.webcache.cn/busuanzi@2.3.0/bsz.pure.mini.js" integrity="sha384-0M75wtSkhjIInv4coYlaJU83+OypaRCIq2SukQVQX04eGTCBXJDuWAbJet56id+S" crossorigin="anonymous" async></script>




<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then((registrations) => {
      for (let registration of registrations) {
        registration.unregister();
      }
    });
  }
</script>

  <!-- hexo injector body_end start -->
<script src="/js/insert_highlight.js" data-pjax></script>
<!-- hexo injector body_end end --></body>
  </html>

